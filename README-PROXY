# Proxy Mode with CKPOOL-LHR

## Use Case

Proxy mode acts as an intermediary between downstream miners and an upstream pool.
All shares from downstream miners are aggregated and forwarded to the upstream pool
as a single user connection. The upstream pool sees only one worker regardless of
how many downstream miners are connected.

**Ideal for:**
- Aggregating multiple miners behind NAT
- Reducing connection overhead for upstream pool
- Providing local proxy for remote miners
- Simplifying network topology

## How Proxy Mode Works

In proxy mode, ckpool-lhr accepts connections from downstream miners and presents
all their shares to the upstream pool as a single aggregated connection. The
upstream pool sees one worker with combined hash rate from all downstream miners.

**Workflow**: Downstream miners connect → Subscribe → Authorize → Receive work →
Submit shares → Proxy aggregates shares → Forwards to upstream pool as single
user → Upstream pool validates and responds → Proxy forwards responses to
downstream miners.

**Important**: The upstream pool must be ckpool-compatible for scalability to
large hash rates. Other pool software may not handle the aggregated connection
properly.

For complete configuration reference, see the main README.

---

## Required Options

### Command Line

**`-p` or `--proxy`**: **REQUIRED** to start ckpool-lhr in proxy mode.

Example:
```bash
src/ckpool -p
```

Alternatively, use the `ckproxy` symlink if available:
```bash
src/ckproxy
```

### Configuration File

**"proxy"** : Upstream pool connection configuration. **REQUIRED**
- Type: Array of objects
- Each entry: url (string, required), auth (string, required), pass (string, required)
- Multiple entries can be specified for redundancy/load balancing
- Example:
```json
"proxy" : [
    {
        "url" : "upstream.pool.com:3333",
        "auth" : "username",
        "pass" : "password"
    },
    {
        "url" : "backup.pool.com:3333",
        "auth" : "username",
        "pass" : "password"
    }
]
```

---

## Quick Start

### 1. Create Configuration File

Copy the example configuration file and customize it:
```bash
cp ckproxy.conf.example ckproxy.conf
```

Edit `ckproxy.conf` with the required `proxy` setting (see Required Options above).

### 2. Start ckpool-lhr in Proxy Mode

```bash
src/ckpool -p
```

Or use the symlink:
```bash
src/ckproxy
```

### 3. Configure Your Miners

Point your mining hardware to the proxy:
- **URL**: `192.168.1.100:3334` (your proxy IP address, default port 3334)
- **Username**: Your upstream pool username
- **Password**: Your upstream pool password

---

## Optional Configuration Options

All configuration options relevant to proxy mode are listed below. Options not
listed (btcd, btcaddress, redirecturl, nodeserver, trusted) are not used in proxy mode.

**"upstream"** : Upstream pool URL for trusted remote mode. **OPTIONAL**
- Type: String
- Values: "hostname:port" format
- Default: None
- Note: Used when operating as a trusted remote proxy that connects to an upstream pool.
  The upstream pool should specify this proxy in its "trusted" configuration.
- Example: `"upstream" : "main.pool.com:3336"`

**"serverurl"** : Server bindings for miner connections. **OPTIONAL**
- Type: Array of strings
- Values: "IP:port" or "hostname:port"
- Default: All interfaces on port 3334
- Note: Ports below 1024 usually require privileged access
- Example: `"serverurl" : ["192.168.1.100:3334", "127.0.0.1:3334"]`

**"mindiff"** : Minimum difficulty for vardiff. **OPTIONAL**
- Type: Double
- Values: Any positive number
- Default: 1.0
- Note: Supports sub-"1" values (e.g., 0.0005) for low hash rate miners.
- Example: `"mindiff" : 0.0005`

**"startdiff"** : Starting difficulty for new clients. **OPTIONAL**
- Type: Double
- Values: Any positive number
- Default: 42.0
- Note: Can be set below 1 for low hash rate miners.
- Example: `"startdiff" : 0.0005`

**"maxdiff"** : Maximum difficulty for vardiff. **OPTIONAL**
- Type: Integer64
- Values: Positive integer, or 0 for no maximum
- Default: 0 (no maximum)

**"update_interval"** : Frequency to send stratum updates. **OPTIONAL**
- Type: Integer
- Values: Seconds (positive integer)
- Default: 30

**"nonce2length"** : Length of extranonce2 in bytes. **OPTIONAL**
- Type: Integer
- Values: 2-8
- Default: 0 (proxy mode)

**"logdir"** : Directory for logs. **OPTIONAL**
- Type: String
- Default: "logs"

**"maxclients"** : Maximum concurrent client connections. **OPTIONAL**
- Type: Integer
- Default: 0 (no limit)

**"useragent"** : Allowed user agent strings (whitelist). **OPTIONAL**
- Type: Array of strings
- Default: None (all allowed)
- Note: Prefix matching. Empty user agents rejected if whitelist configured.

