# Proxy Mode with CKPOOL-LHR

## Use Case

Proxy mode acts as an intermediary between downstream miners and an upstream pool.
All shares from downstream miners are aggregated and forwarded to the upstream pool
as a single user connection. The upstream pool sees only one worker regardless of
how many downstream miners are connected.

**Ideal for:**
- Aggregating multiple miners behind NAT
- Reducing connection overhead for upstream pool
- Providing local proxy for remote miners
- Simplifying network topology

## How Proxy Mode Works

In proxy mode, ckpool-lhr accepts connections from downstream miners and presents
all their shares to the upstream pool as a single aggregated connection. The
upstream pool sees one worker with combined hash rate from all downstream miners.

**Workflow**: Downstream miners connect → Subscribe → Authorize → Receive work →
Submit shares → Proxy aggregates shares → Forwards to upstream pool as single
user → Upstream pool validates and responds → Proxy forwards responses to
downstream miners.

**Important**: The upstream pool must be ckpool-compatible for scalability to
large hash rates. Other pool software may not handle the aggregated connection
properly.

For complete configuration reference, see the main README.

---

## Required Options

### Command Line

**`-p` or `--proxy`**: **REQUIRED** to start ckpool-lhr in proxy mode.

Example:
```bash
src/ckpool -p
```

Alternatively, use the `ckproxy` symlink if available:
```bash
src/ckproxy
```

### Configuration File

**"proxy"** : Upstream pool connection configuration. **REQUIRED**
- Type: Array of objects
- Each entry: url (string, required), auth (string, required), pass (string, required)
- Multiple entries can be specified for redundancy/load balancing
- Example:
```json
"proxy" : [
    {
        "url" : "upstream.pool.com:3333",
        "auth" : "username",
        "pass" : "password"
    },
    {
        "url" : "backup.pool.com:3333",
        "auth" : "username",
        "pass" : "password"
    }
]
```

---

## Quick Start

### 1. Create Configuration File

Copy the example configuration file and customize it:
```bash
cp ckproxy.conf.example ckproxy.conf
```

Edit `ckproxy.conf` with the required `proxy` setting (see Required Options above).

### 2. Start ckpool-lhr in Proxy Mode

```bash
src/ckpool -p
```

Or use the symlink:
```bash
src/ckproxy
```

### 3. Configure Your Miners

Point your mining hardware to the proxy:
- **URL**: `192.168.1.100:3334` (your proxy IP address, default port 3334)
- **Username**: Your upstream pool username
- **Password**: Your upstream pool password

---

## Optional Configuration Options

All configuration options relevant to proxy mode are listed below. Options not
listed (btcd, btcaddress, redirecturl, nodeserver, trusted, upstream) are not
used in proxy mode.

**"serverurl"** : Server bindings for downstream miner connections. **OPTIONAL**
- Type: Array of strings
- Values: "IP:port" or "hostname:port"
- Default: All interfaces on port 3334
- Note: Ports below 1024 usually require privileged access
- Example: `"serverurl" : ["192.168.1.100:3334", "127.0.0.1:3334"]`

**"mindiff"** : Minimum difficulty that vardiff will allow miners to drop to. **OPTIONAL**
- Type: Double
- Values: Any positive number (no minimum floor)
- Default: 1.0
- Note: This fork supports sub-"1" values (e.g., 0.0005) for low hash rate miners.
  Automatic vardiff adjustment will not reduce difficulty below 1, but manually
  configured mindiff values below 1 will work correctly.
- Example: `"mindiff" : 0.0005`

**"startdiff"** : Starting difficulty for new clients. **OPTIONAL**
- Type: Double
- Values: Any positive number (no minimum floor)
- Default: 42.0
- Note: Can be set below 1 (e.g., 0.0005) for low hash rate miners. If startdiff
  is set below 1, clients will start at that difficulty. While automatic vardiff
  adjustment will not reduce difficulty below 1, it can still increase difficulty
  if the miner's hash rate warrants it.
- Example: `"startdiff" : 0.0005`

**"maxdiff"** : Maximum difficulty that vardiff will clamp to. **OPTIONAL**
- Type: Integer64
- Values: Positive integer, or 0 for no maximum
- Default: 0 (no maximum)

**"update_interval"** : Frequency to send stratum updates to miners. **OPTIONAL**
- Type: Integer
- Values: Seconds (positive integer)
- Default: 30

**"nonce2length"** : Length of extranonce2 in bytes. **OPTIONAL**
- Type: Integer
- Values: 2-8
- Default: 0 (in proxy mode if not specified)

**"logdir"** : Directory for storing pool and client logs. **OPTIONAL**
- Type: String
- Values: Valid directory path
- Default: "logs"

**"maxclients"** : Maximum number of concurrent client connections. **OPTIONAL**
- Type: Integer
- Values: Positive integer
- Default: No limit
- Note: Connections beyond this limit are rejected

**"useragent"** : Allowed user agent strings for miner connections. **OPTIONAL**
- Type: Array of strings
- Values: String patterns (prefix matching)
- Default: Not configured (allow all)
- Note: If configured, only miners with user agents matching an entry in the whitelist are allowed. Empty user agent strings do not match any pattern and will be rejected if whitelist is configured.

