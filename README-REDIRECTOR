# Redirector Mode with CKPOOL-LHR

## Use Case

Redirector mode acts as a front-end filter that redirects active miners to other
pools. It filters out users that never contribute shares, and once an accepted
share from the upstream pool is detected, it issues a redirect to one of the
configured redirect URLs. This allows for load balancing across multiple pools
and filtering inactive miners before redirect.

**Ideal for:**
- Load balancing across multiple pools
- Filtering inactive miners before redirect
- Distributing miners across pool infrastructure
- Testing and validation of miner activity

## How Redirector Mode Works

In redirector mode, ckpool-lhr accepts connections from miners and initially
forwards them to an upstream pool. The redirector monitors share submissions
and filters out miners that never contribute valid shares. Once a miner submits
an accepted share, the redirector issues a stratum redirect message to one of
the configured redirect URLs, sending the miner to the target pool.

**Workflow**: Miners connect → Subscribe → Authorize → Receive work → Submit
shares → Redirector forwards to upstream pool → Upstream pool validates shares →
If share accepted, redirector issues redirect to configured URL → Miner
reconnects to target pool → Miners without accepted shares remain filtered.

**Important**: 
- The redirector cycles over multiple redirect URLs if configured
- Attempts to keep clients from the same IP redirecting to the same pool
- Miners that never submit accepted shares are filtered out and not redirected

For complete configuration reference, see the main README.

---

## Required Options

### Command Line

**`-R` or `--redirector`**: **REQUIRED** to start ckpool-lhr in redirector mode.

Example:
```bash
src/ckpool -R
```

### Configuration File

**"proxy"** : Upstream pool connection configuration. **REQUIRED**
- Type: Array of objects
- Each entry: url (string, required), auth (string, required), pass (string, required)
- Used for initial validation of miner shares before redirect
- Example:
```json
"proxy" : [
    {
        "url" : "validation.pool.com:3333",
        "auth" : "username",
        "pass" : "password"
    }
]
```

**"redirecturl"** : URLs for redirecting active miners. **REQUIRED**
- Type: Array of strings
- Values: "hostname:port" format (must be resolvable)
- Multiple entries can be specified for load balancing
- Redirector cycles over entries but tries to keep clients from same IP on same pool
- Example:
```json
"redirecturl" : [
    "node1.pool.com:3333",
    "node2.pool.com:3333",
    "node3.pool.com:3333"
]
```

---

## Quick Start

### 1. Create Configuration File

Copy the example configuration file and customize it:
```bash
cp ckredirector.conf.example ckredirector.conf
```

Edit `ckredirector.conf` with the required `proxy` and `redirecturl` settings
(see Required Options above).

### 2. Start ckpool-lhr in Redirector Mode

```bash
src/ckpool -R
```

### 3. Configure Your Miners

Point your mining hardware to the redirector:
- **URL**: `192.168.1.100:3334` (your redirector IP address, default port 3334)
- **Username**: Your upstream pool username (for initial validation)
- **Password**: Your upstream pool password (for initial validation)

**Note**: After submitting an accepted share, miners will be redirected to one
of the configured redirect URLs and should reconnect automatically.

---

## Optional Configuration Options

All configuration options relevant to redirector mode are listed below. Options
not listed (btcd, btcaddress, nodeserver, trusted, upstream) are not used in
redirector mode.

**"serverurl"** : Server bindings for miner connections. **OPTIONAL**
- Type: Array of strings
- Values: "IP:port" or "hostname:port"
- Default: All interfaces on port 3334
- Note: Ports below 1024 usually require privileged access
- Example: `"serverurl" : ["192.168.1.100:3334", "127.0.0.1:3334"]`

**"mindiff"** : Minimum difficulty for vardiff. **OPTIONAL**
- Type: Double
- Values: Any positive number
- Default: 1.0
- Note: Supports sub-"1" values (e.g., 0.0005) for low hash rate miners.
- Example: `"mindiff" : 0.0005`

**"startdiff"** : Starting difficulty for new clients. **OPTIONAL**
- Type: Double
- Values: Any positive number
- Default: 42.0
- Note: Can be set below 1 for low hash rate miners.
- Example: `"startdiff" : 0.0005`

**"maxdiff"** : Maximum difficulty for vardiff. **OPTIONAL**
- Type: Integer64
- Values: Positive integer, or 0 for no maximum
- Default: 0 (no maximum)

**"update_interval"** : Frequency to send stratum updates. **OPTIONAL**
- Type: Integer
- Values: Seconds (positive integer)
- Default: 30

**"logdir"** : Directory for logs. **OPTIONAL**
- Type: String
- Default: "logs"

**"maxclients"** : Maximum concurrent client connections. **OPTIONAL**
- Type: Integer
- Default: 0 (no limit)

**"useragent"** : Allowed user agent strings (whitelist). **OPTIONAL**
- Type: Array of strings
- Default: None (all allowed)
- Note: Prefix matching. Empty user agents rejected if whitelist configured.

