# Userproxy Mode with CKPOOL-LHR

## Use Case

Userproxy mode is a proxy mode that preserves individual miner credentials to
the upstream pool. It accepts username/password from each stratum connection and
opens additional connections with those credentials to the upstream pool, allowing
each miner to maintain their separate identity on the upstream pool.

**Ideal for:**
- Transparent proxy preserving miner authentication
- Multi-pool aggregation with individual tracking
- Credential passthrough scenarios
- Maintaining individual miner statistics on upstream pool

## How Userproxy Mode Works

In userproxy mode, ckpool-lhr accepts connections from downstream miners and
extracts their username/password credentials from the stratum authorization
message. For each unique set of credentials, the userproxy opens a separate
connection to the upstream pool using those credentials. Each downstream miner
maintains their individual identity on the upstream pool, allowing for separate
tracking and statistics.

**Workflow**: Downstream miners connect → Subscribe → Authorize with
username/password → Userproxy extracts credentials → Opens connection to
upstream pool with those credentials → Forwards work to downstream miner →
Downstream miner submits shares → Userproxy forwards shares to upstream pool
on appropriate connection → Upstream pool validates and responds → Userproxy
forwards responses to downstream miner.

**Important**: 
- Each miner maintains separate identity on upstream pool
- Requires upstream pool to support multiple connections with different credentials
- Requires additional resources due to multiple upstream connections per unique credential set

For complete configuration reference, see the main README.

---

## Required Options

### Command Line

**`-u` or `--userproxy`**: **REQUIRED** to start ckpool-lhr in userproxy mode.

Example:
```bash
src/ckpool -u
```

### Configuration File

**"proxy"** : Upstream pool connection configuration. **REQUIRED**
- Type: Array of objects
- Each entry: url (string, required), auth (string, required), pass (string, required)
- Multiple entries can be specified for redundancy/load balancing
- Note: The auth/pass in proxy config may be used as fallback, but individual
  miner credentials take precedence
- Example:
```json
"proxy" : [
    {
        "url" : "upstream.pool.com:3333",
        "auth" : "username",
        "pass" : "password"
    },
    {
        "url" : "backup.pool.com:3333",
        "auth" : "username",
        "pass" : "password"
    }
]
```

---

## Quick Start

### 1. Create Configuration File

Copy the example configuration file and customize it:
```bash
cp ckproxy.conf.example ckproxy.conf
```

Edit `ckproxy.conf` with the required `proxy` setting (see Required Options above).

### 2. Start ckpool-lhr in Userproxy Mode

```bash
src/ckpool -u
```

### 3. Configure Your Miners

Point your mining hardware to the userproxy:
- **URL**: `192.168.1.100:3334` (your userproxy IP address, default port 3334)
- **Username**: Your upstream pool username (preserved to upstream)
- **Password**: Your upstream pool password (preserved to upstream)

**Note**: Each miner should use their own upstream pool credentials. The
userproxy will create separate connections to the upstream pool for each unique
set of credentials.

---

## Optional Configuration Options

All configuration options relevant to userproxy mode are listed below. Options
not listed (btcd, btcaddress, redirecturl, nodeserver, trusted, upstream) are
not used in userproxy mode.

**"serverurl"** : Server bindings for downstream miner connections. **OPTIONAL**
- Type: Array of strings
- Values: "IP:port" or "hostname:port"
- Default: All interfaces on port 3334
- Note: Ports below 1024 usually require privileged access
- Example: `"serverurl" : ["192.168.1.100:3334", "127.0.0.1:3334"]`

**"mindiff"** : Minimum difficulty that vardiff will allow miners to drop to. **OPTIONAL**
- Type: Double
- Values: Any positive number (no minimum floor)
- Default: 1.0
- Note: This fork supports sub-"1" values (e.g., 0.0005) for low hash rate miners.
  Automatic vardiff adjustment will not reduce difficulty below 1, but manually
  configured mindiff values below 1 will work correctly.
- Example: `"mindiff" : 0.0005`

**"startdiff"** : Starting difficulty for new clients. **OPTIONAL**
- Type: Double
- Values: Any positive number (no minimum floor)
- Default: 42.0
- Note: Can be set below 1 (e.g., 0.0005) for low hash rate miners. If startdiff
  is set below 1, clients will start at that difficulty. While automatic vardiff
  adjustment will not reduce difficulty below 1, it can still increase difficulty
  if the miner's hash rate warrants it.
- Example: `"startdiff" : 0.0005`

**"maxdiff"** : Maximum difficulty that vardiff will clamp to. **OPTIONAL**
- Type: Integer64
- Values: Positive integer, or 0 for no maximum
- Default: 0 (no maximum)

**"update_interval"** : Frequency to send stratum updates to miners. **OPTIONAL**
- Type: Integer
- Values: Seconds (positive integer)
- Default: 30

**"nonce2length"** : Length of extranonce2 in bytes. **OPTIONAL**
- Type: Integer
- Values: 2-8
- Default: 0 (in proxy mode if not specified)

**"logdir"** : Directory for storing pool and client logs. **OPTIONAL**
- Type: String
- Values: Valid directory path
- Default: "logs"

**"maxclients"** : Maximum number of concurrent client connections. **OPTIONAL**
- Type: Integer
- Values: Positive integer
- Default: No limit
- Note: Connections beyond this limit are rejected

**"useragent"** : Allowed user agent strings for miner connections. **OPTIONAL**
- Type: Array of strings
- Values: String patterns (prefix matching)
- Default: Not configured (allow all)
- Note: If configured, only miners with user agents matching an entry in the whitelist are allowed. Empty user agent strings do not match any pattern and will be rejected if whitelist is configured.

